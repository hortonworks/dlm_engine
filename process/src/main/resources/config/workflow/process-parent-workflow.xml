<!--
  ~ Licensed to the Apache Software Foundation (ASF) under one
  ~ or more contributor license agreements.  See the NOTICE file
  ~ distributed with this work for additional information
  ~ regarding copyright ownership.  The ASF licenses this file
  ~ to you under the Apache License, Version 2.0 (the
  ~ "License"); you may not use this file except in compliance
  ~ with the License.  You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->
<workflow-app xmlns='uri:oozie:workflow:0.3' name='ivory-process-parent-workflow'>
	<start to='recordsize' />
	<action name='recordsize'>
		<java>
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<main-class>org.apache.ivory.latedata.LateDataHandler</main-class>
			<arg>-mode</arg><arg>record</arg>
			<arg>-out</arg><arg>${logDir}/latedata-${nominalTime}</arg>
			<arg>-paths</arg><arg>${ivoryInPaths}</arg>
			<arg>-oozie</arg><arg>${workflowEngineUrl}</arg>
			<arg>-extid</arg><arg>${wf:conf("oozie.wf.external.id")}</arg>
			<capture-output />
		</java>
		<ok to="user-workflow" />
		<error to="ivory-failed-messaging" />
	</action>

	<action name='user-workflow'>
		<sub-workflow>
			<app-path>#USER_WF_PATH#</app-path>
			<propagate-configuration />
		</sub-workflow>
		<ok to="fork-for-succeeded" />
		<error to="fork-for-failed" />
	</action>

	<fork name="fork-for-succeeded">
		<path start="ivory-succeeded-messaging" />
		<path start="user-jms-messaging" />
		<path start="ivory-succeeded-log-mover" />
	</fork>
	<join name="join-for-succeeded" to="end" />

	<fork name="fork-for-failed">
		<path start="ivory-failed-messaging" />
		<path start="ivory-failed-log-mover" />
	</fork>
	<join name="join-for-failed" to="fail" />

	<action name='ivory-succeeded-messaging'>
		<java>
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<main-class>org.apache.ivory.messaging.MessageProducer</main-class>
			<arg>${entityName}</arg>
			<arg>${feedNames}</arg>
			<arg>${feedInstancePaths}</arg>
			<arg>${wf:id()}</arg>
			<arg>${wf:run()}</arg>
			<arg>${nominalTime}</arg>
			<arg>${timeStamp}</arg>
			<arg>${brokerUrl}</arg>
			<arg>${brokerImplClass}</arg>
			<arg>${entityType}</arg>
			<arg>${operation}</arg>
			<arg>${logDir}/instancePaths-${nominalTime}.csv</arg>
			<arg>IVORY.PROCESS.TOPIC</arg>
			<arg>SUCCEEDED</arg>
		</java>
		<ok to="join-for-succeeded" />
		<error to="fail" />
	</action>
	<action name='ivory-succeeded-log-mover'>
		<java>
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<main-class>org.apache.ivory.logging.LogMover</main-class>
			<arg>-oozieurl ${workflowEngineUrl}</arg>
			<arg>-subflowid ${wf:id()}@user-workflow</arg>
			<arg>-runid ${wf:run()}</arg>
			<arg>-logdir ${userWorkflowPath}/log/</arg>
			<arg>-externalid ${wf:conf("oozie.wf.external.id")}</arg>
			<arg>-status SUCCEEDED</arg>
		</java>
		<ok to="join-for-succeeded" />
		<error to="fail" />
	</action>
	<action name='ivory-failed-log-mover'>
		<java>
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<main-class>org.apache.ivory.logging.LogMover</main-class>
			<arg>-oozieurl ${workflowEngineUrl}</arg>
			<arg>-subflowid ${wf:id()}@user-workflow</arg>
			<arg>-runid ${wf:run()}</arg>
			<arg>-logdir ${userWorkflowPath}/log/</arg>
			<arg>-externalid ${wf:conf("oozie.wf.external.id")}</arg>
			<arg>-status FAILED</arg>
		</java>
		<ok to="join-for-failed" />
		<error to="fail" />
	</action>
	<action name='ivory-failed-messaging'>
		<java>
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<main-class>org.apache.ivory.messaging.MessageProducer</main-class>
			<arg>${entityName}</arg>
			<arg>${feedNames}</arg>
			<arg>${feedInstancePaths}</arg>
			<arg>${wf:id()}</arg>
			<arg>${wf:run()}</arg>
			<arg>${nominalTime}</arg>
			<arg>${timeStamp}</arg>
			<arg>${brokerUrl}</arg>
			<arg>${brokerImplClass}</arg>
			<arg>${entityType}</arg>
			<arg>${operation}</arg>
			<arg>${logDir}/instancePaths-${nominalTime}.csv</arg>
			<arg>IVORY.PROCESS.TOPIC</arg>
			<arg>FAILED</arg>
		</java>
		<ok to="join-for-failed" />
		<error to="fail" />
	</action>
	<action name='user-jms-messaging'>
		<java>
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<main-class>org.apache.ivory.messaging.MessageProducer</main-class>
			<arg>${entityName}</arg>
			<arg>${feedNames}</arg>
			<arg>${feedInstancePaths}</arg>
			<arg>${wf:id()}</arg>
			<arg>${wf:run()}</arg>
			<arg>${nominalTime}</arg>
			<arg>${timeStamp}</arg>
			<arg>${brokerUrl}</arg>
			<arg>${brokerImplClass}</arg>
			<arg>${entityType}</arg>
			<arg>${operation}</arg>
			<arg>${logDir}/instacePaths-${nominalTime}.csv</arg>
			<arg>${entityName}</arg>
			<arg>SUCCEEDED</arg>
		</java>
		<ok to="join-for-succeeded" />
		<error to="fail" />
	</action>

	<kill name="fail">
		<message>Workflow failed, error
			message[${wf:errorMessage(wf:lastErrorNode())}]
		</message>
	</kill>
	<end name='end' />
</workflow-app>
